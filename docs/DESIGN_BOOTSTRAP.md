# Design: Node Bootstrap Process

## Overview

This document describes the secure bootstrap process for edge nodes to register with the KDC and establish mutual authentication. The bootstrap process uses one-time authentication tokens, DNSSEC-validated KDC public keys, and HPKE authenticated encryption.

## Goals

1. **Secure Initial Registration**: Prevent unauthorized nodes from registering
2. **Mutual Key Exchange**: Node and KDC exchange public keys securely
3. **Token-Based Authentication**: One-time tokens control who can bootstrap
4. **DNSSEC Validation**: KDC public key retrieved and validated via DNSSEC
5. **Sender Authentication**: HPKE Auth mode ensures node identity

## Components

### 1. Bootstrap Blob

- **Purpose**: Self-contained package containing all information needed for node bootstrap
- **Generation**: Generated by KDC admin via CLI (`kdc-cli bootstrap generate`)
- **Contents**:
  - Token value (cryptographically random, 32+ bytes)
  - Node ID (assigned by KDC)
  - KDC HPKE public key (32 bytes, X25519)
  - KDC bootstrap address (IP:port where KDC accepts bootstrap requests)
  - Control zone name (e.g., `kdc.example.com.`)
- **Format**: Base64-encoded JSON blob
- **File Format**: Written to `{nodeid}.bootstrap` file
- **Transport**: Can be transported offline (USB stick, etc.) - no expiration until activated
- **Activation**: Separate operation (`kdc-cli bootstrap activate`) starts expiration timer

### 2. Bootstrap Activation

- **Purpose**: Opens time window for node to complete bootstrap
- **Operation**: `kdc-cli bootstrap activate --nodeid <nodeid>`
- **Effect**: 
  - Sets expiration timestamp (e.g., 5 minutes from activation)
  - Marks token as "active" (ready to accept bootstrap requests)
  - Node must complete bootstrap within expiration window
- **Storage**: Token stored with:
  - Token value
  - Node ID
  - Created timestamp
  - Activated timestamp (when activation command run)
  - Expiration timestamp (activated + 5 minutes)
  - Used flag (false until bootstrap succeeds)

### 3. Node Key Generation

During bootstrap, the node generates two keypairs:

1. **HPKE Keypair (X25519)**:
   - Used for encrypted communication with KDC
   - Long-term keypair (stored securely)
   - Public key sent to KDC during bootstrap

2. **SIG(0) Keypair (Ed25519)**:
   - Used for signing DNS UPDATE messages
   - Public key sent to KDC during bootstrap
   - Used to sign the bootstrap DNS UPDATE

### 4. Bootstrap Blob File Structure

The bootstrap blob file (`{nodeid}.bootstrap`) contains base64-encoded JSON:

```json
{
  "token": "<cryptographically random token, hex/base64>",
  "node_id": "<assigned node ID, e.g., edgesigner1.example.com.>",
  "kdc_hpke_pubkey": "<32-byte X25519 public key, hex/base64>",
  "kdc_bootstrap_address": "<IP:port, e.g., 192.0.2.1:5353>",
  "control_zone": "<zone name, e.g., kdc.example.com.>"
}
```

**Note**: No expiration timestamp - expiration starts when blob is activated.

### 5. Bootstrap Request Structure

The encrypted bootstrap request (sent in CHUNK record) contains:

```json
{
  "hpke_pubkey": "<32-byte X25519 public key, hex/base64 encoded>",
  "sig0_pubkey": "<Ed25519 public key, DNSKEY RR format string>",
  "auth_token": "<token from bootstrap blob>",
  "timestamp": "<RFC3339 timestamp>",
  "notify_address": "<optional: IP:port for NOTIFY messages>"
}
```

**Note**: Node ID is NOT included - it is assigned by KDC based on the token.

### 6. Transport: SIG(0) Signed DNS UPDATE

- **Method**: DNS UPDATE message signed with SIG(0) using node's Ed25519 key
- **Target Zone**: KDC control zone (from bootstrap blob)
- **Target Name**: Bootstrap subdomain (e.g., `_bootstrap.kdc.example.com.`)
- **RR Type**: CHUNK record containing encrypted bootstrap request
- **KDC Address**: From bootstrap blob (`kdc_bootstrap_address`)
- **Verification**: KDC cannot verify SIG(0) signature initially (doesn't have node's SIG(0) pubkey yet)
  - KDC accepts UPDATE in good faith
  - Extracts CHUNK record
  - Decrypts the bootstrap request using HPKE Auth mode
  - Validates token, timestamp, and other fields
  - If validation fails, transaction is rolled back
  - If validation succeeds, node is registered and SIG(0) key is stored

## Bootstrap Flow

### Phase 1: Bootstrap Blob Generation (Admin)

1. Admin generates bootstrap blob via KDC CLI:
   ```
   kdc-cli bootstrap generate --nodeid edgesigner1.example.com.
   ```
2. KDC:
   - Generates cryptographically random token (32+ bytes)
   - Assigns node ID (provided by admin or auto-generated)
   - Retrieves KDC HPKE public key
   - Retrieves KDC bootstrap address (from config)
   - Retrieves control zone name (from config)
   - Creates bootstrap blob JSON:
     ```json
     {
       "token": "<random token>",
       "node_id": "edgesigner1.example.com.",
       "kdc_hpke_pubkey": "<KDC pubkey>",
       "kdc_bootstrap_address": "192.0.2.1:5353",
       "control_zone": "kdc.example.com."
     }
     ```
   - Base64-encodes JSON blob
   - Writes to file: `edgesigner1.example.com..bootstrap`
   - Stores token in database with:
     - Token value
     - Node ID (assigned)
     - Created timestamp
     - Activated flag = false
     - Used flag = false
     - No expiration timestamp yet
3. Admin transports bootstrap blob file to node operator
   - Can be transported offline (USB stick, etc.)
   - No expiration until activated
   - File can be stored for extended period

### Phase 2: Bootstrap Activation (Admin)

1. Admin activates bootstrap blob when ready:
   ```
   kdc-cli bootstrap activate --nodeid edgesigner1.example.com.
   ```
2. KDC:
   - Looks up token for node ID
   - Sets activated timestamp = now
   - Sets expiration timestamp = now + 5 minutes (configurable)
   - Sets activated flag = true
   - Token is now ready to accept bootstrap requests
3. Admin notifies node operator that bootstrap window is open
   - Node operator must complete bootstrap within expiration window

### Phase 3: Node Bootstrap Preparation

1. Node operator runs bootstrap command:
   ```
   krs-cli bootstrap --input edgesigner1.example.com..bootstrap
   ```
2. KRS reads bootstrap blob file:
   - Decodes base64 JSON
   - Extracts: token, node_id, kdc_hpke_pubkey, kdc_bootstrap_address, control_zone
3. KRS generates keypairs:
   - HPKE keypair (X25519): `hpke.GenerateKeyPair()`
   - SIG(0) keypair (Ed25519): `dns.GenerateKey()`
4. KRS creates bootstrap request:
   ```json
   {
     "hpke_pubkey": "<hex/base64 encoded>",
     "sig0_pubkey": "<DNSKEY RR string>",
     "auth_token": "<token from bootstrap blob>",
     "timestamp": "2025-01-15T10:30:00Z",
     "notify_address": "<optional: IP:port for NOTIFY>"
   }
   ```
5. KRS encrypts bootstrap request using HPKE Auth mode:
   - Uses KRS's HPKE private key (sender authentication)
   - Uses KDC's HPKE public key (from bootstrap blob)
   - Result: Authenticated encrypted ciphertext

### Phase 4: Bootstrap Submission

1. KRS creates bootstrap CHUNK record:
   - Format: JSON (core.FormatJSON)
   - HMAC: None (HMACLen = 0)
   - Sequence: 0 (single chunk)
   - Total: 0 (indicates manifest/bootstrap)
   - Data: Encrypted bootstrap request ciphertext
2. KRS creates DNS UPDATE message:
   - Zone: Control zone (from bootstrap blob)
   - Name: `_bootstrap.{control_zone}`
   - RR Type: CHUNK
   - RDATA: CHUNK record containing encrypted bootstrap request
   - Signs with SIG(0) using KRS's Ed25519 private key
3. KRS sends UPDATE to KDC bootstrap address (from bootstrap blob)
4. KDC receives UPDATE:
   - Cannot verify SIG(0) signature yet (no node pubkey)
   - Accepts UPDATE in good faith
   - Extracts CHUNK record
   - Extracts encrypted blob from CHUNK data
   - Begins transaction (for rollback capability)

### Phase 5: KDC Processing

1. KDC decrypts bootstrap request using HPKE Auth mode:
   - Uses KDC's HPKE private key
   - Uses extracted node's HPKE public key (from request) for verification
   - If decryption fails â†’ rollback transaction, reject UPDATE
2. KDC validates decrypted contents:
   - **Token validation**:
     - Token exists in database
     - Token is activated (`activated = true`)
     - Token not expired (current time < expiration timestamp)
     - Token not already used (`used = false`)
     - Token's assigned node ID matches
   - **Timestamp validation**:
     - Timestamp is recent (e.g., within last 5 minutes)
     - Prevents replay attacks
   - **Key validation**:
     - HPKE pubkey is valid X25519 key (32 bytes)
     - SIG(0) pubkey is valid Ed25519 DNSKEY
3. If validation fails:
   - Mark token as used (prevent replay)
   - Rollback transaction
   - Reject UPDATE with appropriate error
4. If validation succeeds:
   - Store node in database:
     - Node ID (from token)
     - HPKE public key (from request)
     - SIG(0) public key (from request)
     - Notify address (from request, if provided)
     - State: "online"
     - Registered timestamp: now
   - Generate KRS configuration from bootstrap data:
     - Control zone (from token/node record)
     - KDC address (from config)
     - Node ID (from token)
     - HPKE private key (generated by KRS, stored securely)
     - SIG(0) private key (generated by KRS, stored securely)
   - Mark token as used
   - Commit transaction
   - Generate bootstrap confirmation

### Phase 6: Bootstrap Confirmation

1. KDC creates confirmation data:
   ```json
   {
     "node_id": "<assigned node ID>",
     "status": "success",
     "kdc_hpke_pubkey": "<KDC HPKE public key, hex/base64>",
     "timestamp": "<RFC3339>"
   }
   ```
2. KDC encrypts confirmation using HPKE Auth mode:
   - Uses KDC's HPKE private key (sender authentication)
   - Uses node's HPKE public key (recipient encryption)
   - Result: Authenticated encrypted ciphertext
3. KDC creates CHUNK EDNS(0) option:
   - Content type: Bootstrap confirmation (new content type, e.g., 2)
   - Data: Encrypted confirmation ciphertext
   - Format: JSON
   - HMAC: None (HMACLen = 0)
4. KDC sends DNS UPDATE response:
   - Standard DNS UPDATE response (RCODE: NOERROR)
   - Includes CHUNK EDNS(0) option in OPT RR
   - Confirmation data encrypted in EDNS(0) option
5. KRS receives UPDATE response:
   - Extracts CHUNK EDNS(0) option from OPT RR
   - Decrypts confirmation using HPKE Auth mode
   - Validates node_id matches expected value
   - Stores KDC HPKE public key
   - Writes KRS configuration file (generated from bootstrap data)
6. Bootstrap complete
   - KRS is now configured and ready to receive key distributions

## Database Schema Changes

### Bootstrap Tokens Table

```sql
CREATE TABLE IF NOT EXISTS bootstrap_tokens (
    token_id TEXT PRIMARY KEY,
    token_value TEXT NOT NULL UNIQUE,
    node_id TEXT NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    activated_at TIMESTAMP NULL,
    expires_at TIMESTAMP NULL,  -- NULL until activated
    activated BOOLEAN NOT NULL DEFAULT FALSE,
    used BOOLEAN NOT NULL DEFAULT FALSE,
    used_at TIMESTAMP NULL,
    created_by TEXT,  -- Admin user/identifier
    comment TEXT
);

CREATE INDEX IF NOT EXISTS idx_bootstrap_tokens_value ON bootstrap_tokens(token_value);
CREATE INDEX IF NOT EXISTS idx_bootstrap_tokens_node_id ON bootstrap_tokens(node_id);
CREATE INDEX IF NOT EXISTS idx_bootstrap_tokens_expires ON bootstrap_tokens(expires_at);
CREATE INDEX IF NOT EXISTS idx_bootstrap_tokens_activated ON bootstrap_tokens(activated, expires_at);
CREATE INDEX IF NOT EXISTS idx_bootstrap_tokens_used ON bootstrap_tokens(used);
```

### Bootstrap Status Calculation

Status is calculated based on database fields:
- **"generated"**: `activated = false` (blob created but not activated)
- **"active"**: `activated = true` AND `used = false` AND `expires_at > NOW()` (waiting for bootstrap)
- **"expired"**: `activated = true` AND `used = false` AND `expires_at <= NOW()` (expired without bootstrap)
- **"completed"**: `used = true` (bootstrap successfully completed)

### Nodes Table Updates

```sql
-- Add SIG(0) public key column
ALTER TABLE nodes ADD COLUMN sig0_pubkey TEXT;

-- Add index for SIG(0) key lookups (if needed)
CREATE INDEX IF NOT EXISTS idx_nodes_sig0_pubkey ON nodes(sig0_pubkey);
```

## API/CLI Commands

### Bootstrap Commands

```bash
# Generate bootstrap blob (creates {nodeid}.bootstrap file)
kdc-cli bootstrap generate \
    --nodeid edgesigner1.example.com. \
    --comment "Bootstrap for edgesigner1"

# Output: edgesigner1.example.com..bootstrap file created
# File contains base64-encoded JSON with token, node_id, kdc_hpke_pubkey,
# kdc_bootstrap_address, and control_zone

# Activate bootstrap blob (starts 5-minute expiration window)
kdc-cli bootstrap activate --nodeid edgesigner1.example.com.

# List all bootstrap blobs with status
kdc-cli bootstrap list

# Output example:
# NODE ID                          STATUS      CREATED              ACTIVATED             EXPIRES
# edgesigner1.example.com.         generated   2025-01-15 10:00:00  -                     -
# edgesigner2.example.com.         active      2025-01-15 09:00:00  2025-01-15 14:30:00   2025-01-15 14:35:00
# edgesigner3.example.com.         expired     2025-01-15 08:00:00  2025-01-15 13:00:00   2025-01-15 13:05:00
# edgesigner4.example.com.         completed   2025-01-15 07:00:00  2025-01-15 12:00:00   2025-01-15 12:05:00

# Status values:
# - "generated": Blob created but not yet activated
# - "active": Activated and expiration window is open (waiting for bootstrap request)
# - "expired": Activation window expired without successful bootstrap
# - "completed": Bootstrap successfully completed (node registered)

# Get bootstrap token status for specific node
kdc-cli bootstrap status --nodeid edgesigner1.example.com.

# Purge expired and completed bootstraps
kdc-cli bootstrap purge

# Deletes all bootstrap tokens with status "expired" or "completed"
# Useful for cleanup of old bootstrap records

# Delete specific bootstrap token (by node ID)
kdc-cli bootstrap delete --nodeid edgesigner1.example.com.
```

### KRS Bootstrap Command

```bash
# Run bootstrap at node (reads bootstrap blob file)
krs-cli bootstrap --input edgesigner1.example.com..bootstrap

# Process:
# 1. Reads and decodes bootstrap blob
# 2. Generates HPKE and SIG(0) keypairs
# 3. Creates encrypted bootstrap request
# 4. Sends SIG(0) signed DNS UPDATE to KDC
# 5. Receives confirmation in UPDATE response
# 6. Writes KRS configuration file
```

## Security Considerations

### 1. Bootstrap Blob Security
- **Token Generation**: Cryptographically random (use `crypto/rand`)
- **Storage**: Token stored in database (consider hashing for extra security)
- **Blob File**: Contains sensitive data - protect file permissions
- **Transport**: Can be transported offline (USB stick, etc.)
- **Activation**: Two-phase process separates generation from activation
- **Expiration**: Short-lived after activation (5 minutes default)
- **Single-Use**: Marked as used immediately after successful bootstrap
- **Revocation**: Admin can delete unused tokens

### 2. Replay Protection
- **Activation Window**: Token only valid after activation
- **Expiration Window**: Short window (5 minutes) after activation
- **Timestamp Validation**: Reject if timestamp is too old (>5 minutes from activation)
- **Token Single-Use**: Once used, token cannot be reused
- **Nonce**: Consider adding nonce to bootstrap request for additional protection

### 3. Bootstrap Blob Contents
- All bootstrap information in single file
- Self-contained: no external lookups needed
- Includes KDC address and control zone
- Reduces complexity (no DNS resolver needed)
- File can be transported offline

### 4. HPKE Auth Mode
- Provides sender authentication (node's private key)
- Provides confidentiality (encrypted to KDC)
- Prevents man-in-the-middle attacks
- KDC can verify sender identity after decryption

### 5. Transaction Rollback
- KDC uses database transaction for bootstrap
- If any validation fails, entire transaction rolls back
- Prevents partial state updates
- Token marked as used even on failure (prevents retry attacks)

### 6. Error Handling
- **Invalid Token**: Generic error (don't leak token validity)
- **Expired Token**: Clear error message
- **Token Already Used**: Clear error message
- **Decryption Failure**: Generic error (don't leak decryption details)
- **Duplicate Node**: Reject (node already exists)

## Implementation Steps

1. **Database Schema**:
   - Create `bootstrap_tokens` table (with `activated` and `activated_at` fields)
   - Add `sig0_pubkey` column to `nodes` table

2. **Bootstrap Blob Generation**:
   - Implement `kdc-cli bootstrap generate` command
   - Create base64-encoded JSON blob
   - Write to `{nodeid}.bootstrap` file
   - Store token in database (not activated)

3. **Bootstrap Activation**:
   - Implement `kdc-cli bootstrap activate` command
   - Set activation timestamp
   - Set expiration timestamp (activation + 5 minutes)
   - Mark token as activated

4. **Bootstrap List**:
   - Implement `kdc-cli bootstrap list` command
   - Query all bootstrap tokens from database
   - Calculate status for each token
   - Display in formatted table

5. **Bootstrap Purge**:
   - Implement `kdc-cli bootstrap purge` command
   - Delete tokens with status "expired" or "completed"
   - Optionally delete corresponding bootstrap blob files

4. **KDC HPKE Key Management**:
   - Generate KDC HPKE keypair (if not exists)
   - Include pubkey in bootstrap blob
   - Store KDC bootstrap address in config
   - (Optional) Publish in DNS as KEY record for operational use

4. **DNS UPDATE Handler**:
   - Add bootstrap UPDATE handler in KDC
   - Extract CHUNK record from UPDATE
   - Extract encrypted blob from CHUNK data
   - Decrypt using HPKE Auth mode
   - Validate and store node
   - Generate confirmation with CHUNK EDNS(0) option

5. **HPKE Auth Mode Support**:
   - Update HPKE wrapper to support Auth mode
   - Implement `EncryptAuth()` function
   - Implement `DecryptAuth()` function

6. **KRS Bootstrap Client**:
   - Implement `krs-cli bootstrap --input <file>` command
   - Parse bootstrap blob file (base64 decode JSON)
   - Implement keypair generation
   - Implement bootstrap request creation and encryption
   - Implement CHUNK record creation
   - Implement SIG(0) signed DNS UPDATE
   - Extract and decrypt CHUNK EDNS(0) option from response
   - Generate KRS configuration file from bootstrap data

7. **Bootstrap Confirmation**:
   - Implement confirmation generation
   - Implement confirmation in CHUNK EDNS(0) option
   - Include KRS config data in confirmation

8. **KRS Configuration Generation**:
   - Generate config file after successful bootstrap
   - Include: node_id, control_zone, kdc_address, database path
   - Store HPKE and SIG(0) private keys securely

## Open Questions

1. **CHUNK Content Type**: Define new content type for bootstrap confirmation?
   - Current: `CHUNKContentTypeKeyStatus = 1`
   - Bootstrap confirmation: `CHUNKContentTypeBootstrapConfirmation = 2`?

2. **Token Hashing**: Should tokens be hashed in database?
   - Pros: Prevents token leakage if DB is compromised
   - Cons: More complex validation

3. **Node ID Format**: What format for node IDs?
   - FQDN (e.g., `edgesigner1.example.com.`)?
   - UUID?
   - Deterministic from token?

4. **Bootstrap Retry**: Should nodes be able to retry with same token if bootstrap fails?
   - Current design: Token marked as used on any failure
   - Alternative: Only mark as used on success

5. **Bootstrap Blob File Format**: Current design uses base64-encoded JSON
   - Consider: Encrypted blob file?
   - Consider: QR code for small deployments?
   - Consider: File permissions and security

6. **KRS Config Generation**: What should be included in generated config?
   - Node ID (from bootstrap blob)
   - Control zone (from bootstrap blob)
   - KDC address (from bootstrap blob)
   - Database path (local to node)
   - Key storage paths (local to node)

## Future Enhancements

1. **Bulk Bootstrap Generation**: Generate multiple bootstrap blobs at once
2. **Bootstrap Templates**: Pre-configure node details in bootstrap blob
3. **Bootstrap Status API**: Check bootstrap status via API
4. **Automatic Cleanup**: Periodic cleanup of expired/completed tokens (via purge command)
5. **Bootstrap Logging**: Detailed audit log of bootstrap attempts
6. **Bootstrap Blob Encryption**: Encrypt bootstrap blob file itself
7. **QR Code Support**: Generate QR code for bootstrap blob (small deployments)
8. **Bootstrap Retry**: Allow retry within activation window if bootstrap fails
9. **Bootstrap List Filtering**: Filter list by status (e.g., `--status expired`)
10. **Bootstrap Purge Confirmation**: Interactive confirmation before purging

